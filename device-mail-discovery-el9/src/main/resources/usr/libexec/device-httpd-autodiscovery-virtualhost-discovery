#!/bin/bash

if [ $# -eq 3 ]; then

  instance="${1}"
  virtualhost="${2}"

  #
  # Handle discovery locations
  
  # find /etc/device/services/mail/discovery/ -mindepth 1 -maxdepth 1 -type l
  while read line; do

    if test -f "$line/disabled.bin"; then
      logger -t $0 "Mail discovery disabled, ignoring: $(basename ${line})"
      continue;
    fi
 
    if test ! -f "$line/virtualhost.d/listen.d/instance.d/name.txt" -o "${instance}" != "$(head -n 1 $line/virtualhost.d/listen.d/instance.d/name.txt)"; then
      continue;
    fi
    if test ! -f "$line/virtualhost.d/name.txt" -o "${virtualhost}" != "$(head -n 1 $line/virtualhost.d/name.txt)"; then
      continue;
    fi

    # read ldap if present
    if [ -L "/etc/device/services/mail/ldap/ldap-suffix.d" ]; then

      # ldap instance if present
      ldap_instance=""
      if test -f "/etc/device/services/mail/ldap/ldap-suffix.d/instance.d/name.txt"; then
        ldap_instance="$(head -n 1 /etc/device/services/mail/ldap/ldap-suffix.d/instance.d/name.txt)"
      else
        logger -t "${0}" "Error: LDAP enabled, but /etc/device/services/mail/ldap/ldap-suffix.d/instance.d/name.txt missing, discovery ignored: $(basename ${line})"
        continue
      fi
      # ldap suffix if present
      ldap_suffix=""
      if test -f "/etc/device/services/mail/ldap/ldap-suffix.d/suffix.txt"; then
        ldap_suffix="$(head -n 1 /etc/device/services/mail/ldap/ldap-suffix.d/suffix.txt)"
      else
        logger -t "${0}" "Error: LDAP enabled, but /etc/device/services/mail/ldap/ldap-suffix.d/suffix.txt missing, discovery ignored: $(basename ${line})"
        continue
      fi
      uris="ldapi://%2frun%2fslapd-${ldap_instance}.socket"
    fi

    cat >> "device-${instance}-${virtualhost}-discovery.conf" <<- EOF
# Generated by $0 on `date`
# DO NOT MODIFY THIS FILE - it will be overwritten on server restart.
#

Alias /autodiscover /var/www/instance/${instance}/secure/${virtualhost}/mail/autodiscover
<Directory /var/www/instance/${instance}/secure/${virtualhost}/mail/autodiscover>
  require all granted
  Options +Includes
  SetInputFilter LDAP;AUTODISCOVER
  SetOutputFilter INCLUDES
  MetaLDAPURL ldapi://%2frun%2fslapd-${ldap_instance}.socket/${ldap_suffix}?mail,mailHost?sub
  MetaLDAPFilter |(mail=%{ldap:%{env:AUTODISCOVER_EMAILADDRESS}})(mailAlternateAddress=%{ldap:%{env:AUTODISCOVER_EMAILADDRESS}})
  LDAPBind mechanism EXTERNAL
  LogLevel debug
</Directory>

EOF

    install "device-${instance}-${virtualhost}-discovery.conf" "/etc/httpd/conf.device.d/instance/${instance}/secure-${virtualhost}.d/location-_autodiscover_.conf"

    cat >> "device-${instance}-${virtualhost}-autodiscover.xml" <<- EOF
<Autodiscover xmlns="http://schemas.microsoft.com/exchange/autodiscover/responseschema/2006">
  <Response xmlns="http://schemas.microsoft.com/exchange/autodiscover/outlook/responseschema/2006a">
    <User>
      <DisplayName>${virtualhost}</DisplayName>
    </User>
    <Account>
      <AccountType>email</AccountType>
      <Action>settings</Action>
      <Protocol>
        <Type>IMAP</Type>
        <Server><!--#echo encoding="entity" var="LDAP_MAILHOST" --></Server>
        <Port>993</Port>
        <DomainRequired>off</DomainRequired>
        <SPA>off</SPA>
        <SSL>on</SSL>
        <AuthRequired>on</AuthRequired>
        <LoginName><!--#echo encoding="entity" var="AUTODISCOVER_EMAILADDRESS" --></LoginName>
      </Protocol>
      <Protocol>
        <Type>SMTP</Type>
        <Server><!--#echo encoding="entity" var="LDAP_MAILHOST" --></Server>
        <Port>465</Port>
        <DomainRequired>off</DomainRequired>
        <SPA>off</SPA>
        <SSL>on</SSL>
        <AuthRequired>on</AuthRequired>
        <LoginName><!--#echo encoding="entity" var="AUTODISCOVER_EMAILADDRESS" --></LoginName>
      </Protocol>
    </Account>
  </Response>
</Autodiscover>
EOF

    install -D "device-${instance}-${virtualhost}-autodiscover.xml" "/var/www/instance/${instance}/secure/${virtualhost}/mail/autodiscover/autodiscover.xml"

  done < <(find /etc/device/services/mail/discovery/ -mindepth 1 -maxdepth 1 -type l)

fi


